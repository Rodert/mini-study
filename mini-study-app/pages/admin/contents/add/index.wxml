<view class="content-page">
  <view class="top-bar">
    <view class="back-button" bindtap="goBack">
      <text>←</text>
    </view>
    <view class="top-title">新增学习内容</view>
    <view class="top-placeholder"></view>
  </view>

  <view class="form-wrapper">
    <view class="form-item">
      <view class="form-label">标题</view>
      <input class="form-input" placeholder="请输入内容标题" value="{{form.title}}" data-field="title" bindinput="handleInput" />
    </view>

    <view class="form-item">
      <view class="form-label">所属分类</view>
      <picker class="picker" mode="selector" range="{{categoryNames}}" value="{{categoryIndex}}" bindchange="handleCategoryChange">
        <view class="picker-value">
          {{categoryIndex >= 0 ? categoryNames[categoryIndex] : '请选择分类'}}
        </view>
      </picker>
    </view>

    <view class="form-item">
      <view class="form-label">内容类型</view>
      <picker class="picker" mode="selector" range="{{typeOptions}}" range-key="label" value="{{typeIndex}}" bindchange="handleTypeChange">
        <view class="picker-value">
          {{typeOptions[typeIndex].label}}
        </view>
      </picker>
    </view>

    <view class="form-item" wx:if="{{form.type === 'video'}}">
      <view class="form-label">视频时长 (秒)</view>
      <input class="form-input" type="number" placeholder="例如：3600" value="{{form.duration_seconds}}" data-field="duration_seconds" bindinput="handleInput" />
    </view>

    <view class="form-item" wx:if="{{form.type !== 'article'}}">
      <view class="form-label">文件上传</view>
      <view class="file-upload">
        <input
          class="form-input readonly"
          placeholder="请通过上传获取文件路径"
          value="{{form.file_path}}"
          disabled
        />
        <button
          class="btn-upload"
          loading="{{uploadingFile}}"
          disabled="{{uploadingFile}}"
          bindtap="handleUploadFile"
        >
          {{uploadingFile ? '上传中...' : (form.type === 'video' ? '上传视频' : '上传文档')}}
        </button>
      </view>
      <view class="upload-tip">
        {{form.type === 'video' ? '支持 mp4/mov，返回的服务器路径将自动填写' : '支持 pdf/doc/ppt/xls 等常见文档，上传后自动填写路径'}}
      </view>
    </view>

    <view class="form-item">
      <view class="form-label">封面图片</view>
      <view class="file-upload">
        <input
          class="form-input readonly"
          placeholder="请通过上传获取封面图片路径"
          value="{{form.cover_url}}"
          disabled
        />
        <button
          class="btn-upload"
          loading="{{uploadingCover}}"
          disabled="{{uploadingCover}}"
          bindtap="handleUploadCover"
        >
          {{uploadingCover ? '上传中...' : '上传封面'}}
        </button>
      </view>
      <view class="upload-tip">
        支持 jpg/png 等常见图片格式，上传后自动填写路径
      </view>
      <view class="cover-preview" wx:if="{{form.cover_url}}">
        <image class="cover-image" src="{{coverPreviewUrl}}" mode="aspectFill" bindtap="handleUploadCover" />
      </view>
    </view>

    <view class="form-item">
      <view class="form-label">简介</view>
      <textarea class="form-textarea" placeholder="请输入内容简介" value="{{form.summary}}" data-field="summary" bindinput="handleInput" maxlength="200" />
    </view>

    <view class="form-item" wx:if="{{form.type === 'article'}}">
      <view class="form-label">图文内容块</view>
      <textarea
        class="form-textarea"
        placeholder="请输入一段文本内容，然后点击“添加文本块”"
        value="{{articleEditorText}}"
        bindinput="handleArticleTextInput"
      />
      <view class="file-upload">
        <button class="btn-upload" bindtap="addArticleTextBlock">添加文本块</button>
        <button
          class="btn-upload"
          loading="{{uploadingFile}}"
          disabled="{{uploadingFile}}"
          bindtap="handleAddArticleImageBlock"
        >
          添加图片块
        </button>
      </view>
      <view class="upload-tip">图文将按顺序展示，可以添加多段文本和多张图片。</view>
      <view wx:if="{{form.article_blocks.length}}">
        <view class="upload-tip">当前内容块：</view>
        <block wx:for="{{form.article_blocks}}" wx:key="index">
          <view class="article-block-row">
            <view wx:if="{{item.type === 'text'}}" class="article-block-text">{{item.text}}</view>
            <view wx:elif="{{item.type === 'image'}}" class="article-block-image-path">图片：{{item.image_path}}</view>
            <button class="btn-upload" data-index="{{index}}" bindtap="removeArticleBlock">删除</button>
          </view>
        </block>
      </view>
    </view>

    <view class="form-item">
      <view class="form-label">可见范围</view>
      <picker class="picker" mode="selector" range="{{visibleRoleOptions}}" range-key="label" value="{{visibleRoleIndex}}" bindchange="handleRoleChange">
        <view class="picker-value">
          {{visibleRoleOptions[visibleRoleIndex].label}}
        </view>
      </picker>
    </view>

    <view class="form-item">
      <view class="form-label">发布状态</view>
      <picker class="picker" mode="selector" range="{{statusOptions}}" range-key="label" value="{{statusIndex}}" bindchange="handleStatusChange">
        <view class="picker-value">
          {{statusOptions[statusIndex].label}}
        </view>
      </picker>
    </view>

    <view class="submit-actions">
      <button class="btn-submit" bindtap="handleSubmit">提交内容</button>
    </view>
  </view>
</view>


