<view class="admin-page">
  <view class="top-bar">
    <view class="back-button" bindtap="goBack">
      <text>←</text>
    </view>
    <view class="top-title">公告管理</view>
    <view class="top-placeholder"></view>
  </view>

  <view class="content">
    <button class="btn-primary" wx:if="{{user.role === 'admin'}}" bindtap="openCreateForm">新增公告</button>

    <view class="banner-list" wx:if="{{notices.length}}">
      <view class="banner-item" wx:for="{{notices}}" wx:key="id">
        <view class="notice-header-row">
          <view class="notice-title-block">
            <view class="banner-title">
              {{item.title}}
              <text class="status-tag {{item.status ? 'active' : 'inactive'}}">
                {{item.status ? '启用' : '停用'}}
              </text>
            </view>
            <view class="notice-meta">
              <text>创建时间：{{item.created_at}}</text>
            </view>
          </view>
        </view>
        <view class="notice-body">
          <image wx:if="{{item.image_preview_url}}" class="notice-cover" src="{{item.image_preview_url}}" mode="aspectFill" />
          <view wx:if="{{item.content}}" class="notice-content-text">{{item.content}}</view>
        </view>
        <!-- 非管理员：确认已读 -->
        <view class="notice-confirm-row" wx:if="{{user.role !== 'admin'}}">
          <button
            class="btn-confirm"
            wx:if="{{!item.confirmed_at}}"
            data-id="{{item.id}}"
            data-index="{{index}}"
            bindtap="handleConfirmNotice"
          >
            确认已读
          </button>
          <view class="confirm-info" wx:else>
            <text>已确认 · {{item.confirmed_at}}</text>
          </view>
        </view>

        <!-- 管理员操作区 -->
        <view class="banner-actions" wx:if="{{user.role === 'admin'}}">
          <button class="btn-secondary" data-index="{{index}}" bindtap="openEditForm">编辑</button>
          <button class="btn-danger" data-index="{{index}}" bindtap="toggleNoticeStatus">
            {{item.status ? '停用' : '启用'}}
          </button>
          <button
            class="btn-secondary"
            data-id="{{item.id}}"
            bindtap="viewConfirmations"
          >
            确认情况
          </button>
        </view>
      </view>
    </view>

    <view class="empty-state" wx:if="{{!notices.length && !loading}}">
      <text>暂无公告</text>
    </view>
  </view>

  <view class="form-modal" wx:if="{{showForm}}">
    <view class="modal-mask" bindtap="closeForm"></view>
    <view class="modal-body">
      <view class="modal-title">{{editingId ? '编辑公告' : '新增公告'}}</view>

      <view class="form-item">
        <view class="form-label">标题</view>
        <input class="form-input" placeholder="请输入公告标题" value="{{form.title}}" data-field="title" bindinput="handleInput" />
      </view>

      <view class="form-item">
        <view class="form-label">内容</view>
        <textarea class="form-input" placeholder="请输入公告内容（可选）" value="{{form.content}}" data-field="content" bindinput="handleInput" />
      </view>

      <view class="form-item">
        <view class="form-label">图片（可选）</view>
        <view class="file-upload">
          <input
            class="form-input readonly"
            placeholder="请通过上传获取图片路径"
            value="{{form.image_url}}"
            disabled
          />
          <button
            class="btn-upload"
            loading="{{uploadingImage}}"
            disabled="{{uploadingImage}}"
            bindtap="handleUploadImage"
          >
            {{uploadingImage ? '上传中...' : '上传图片'}}
          </button>
        </view>
        <view class="upload-tip">
          支持 jpg/png 等常见图片格式，上传后自动填写路径
        </view>
        <view class="image-preview" wx:if="{{form.image_url}}">
          <image class="preview-image" src="{{imagePreviewUrl}}" mode="aspectFill" bindtap="handleUploadImage" />
        </view>
      </view>

      <view class="form-item switch-item">
        <view class="form-label">启用状态</view>
        <switch checked="{{form.status}}" bindchange="handleSwitchChange" />
      </view>

      <view class="form-actions">
        <button class="btn-cancel" bindtap="closeForm">取消</button>
        <button class="btn-submit" bindtap="handleSubmit">{{editingId ? '保存' : '创建'}}</button>
      </view>
    </view>
  </view>

  <!-- 公告确认情况列表（管理员查看） -->
  <view class="confirm-modal" wx:if="{{showConfirmList}}">
    <view class="confirm-mask" bindtap="closeConfirmList"></view>
    <view class="confirm-panel">
      <view class="confirm-header">
        <view class="confirm-title">确认情况</view>
        <view class="confirm-subtitle">{{confirmNoticeTitle}}</view>
      </view>

      <view class="confirm-list" wx:if="{{confirmList.length}}">
        <view class="confirm-item" wx:for="{{confirmList}}" wx:key="user_id">
          <view class="confirm-main">
            <view class="confirm-name">{{item.name || '未知用户'}}</view>
            <view class="confirm-meta">工号：{{item.work_no || '-'}} </view>
          </view>
          <view class="confirm-time">{{item.display_time || item.confirmed_at}}</view>
        </view>
      </view>

      <view class="confirm-empty" wx:if="{{!confirmList.length}}">
        <text>暂无确认记录</text>
      </view>

      <button class="btn-confirm-close" bindtap="closeConfirmList">知道了</button>
    </view>
  </view>
</view>
